<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rigged Roulette</title>
  <style>
    :root {
      --bg: #f2f4f7;
      --wheel: #0f172a;
      --accent: #10b981;
      --text: #0b1021;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", "Avenir Next", "Futura", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 20%, #ffffff, #e8edf5 45%, #dfe6f1 80%);
      display: grid;
      place-items: center;
      padding: 24px;
      user-select: text;
    }
    .card {
      width: min(1100px, 100%);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 25px 50px rgba(15, 23, 42, 0.08);
      border-radius: 28px;
      padding: 28px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 28px;
    }
    @media (max-width: 960px) {
      .card { grid-template-columns: 1fr; }
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h1 span {
      display: inline-flex;
      padding: 8px 10px;
      border-radius: 10px;
      background: #0f172a;
      color: #f0fdf4;
      font-size: 14px;
      letter-spacing: 0.08em;
    }
    p { margin: 8px 0 0; color: var(--muted); line-height: 1.6; }
    .wheel-shell {
      position: relative;
      display: grid;
      place-items: center;
      padding: 6px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(15, 23, 42, 0.2));
      border-radius: 50%;
      animation: pulse 6s ease-in-out infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.015) rotate(1deg); }
    }
    canvas {
      width: 100%;
      height: auto;
      max-width: 520px;
      aspect-ratio: 1 / 1;
      background: radial-gradient(circle, #0f172a 0%, #0b122b 55%, #050914 100%);
      border-radius: 50%;
      box-shadow:
        inset 0 0 0 1px rgba(255, 255, 255, 0.04),
        0 30px 60px rgba(15, 23, 42, 0.4);
    }
    .pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%) rotate(90deg);
      width: 0;
      height: 0;
      border-top: 18px solid transparent;
      border-bottom: 18px solid transparent;
      border-left: 26px solid var(--accent);
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.2));
    }
    .controls {
      display: grid;
      gap: 16px;
      align-content: start;
    }
    textarea {
      width: 100%;
      min-height: 190px;
      resize: vertical;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 14px;
      padding: 14px 16px;
      font-family: inherit;
      font-size: 15px;
      background: #f8fafc;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      user-select: text;
    }
    textarea:focus {
      border-color: rgba(16, 185, 129, 0.6);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }
    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .primary {
      background: linear-gradient(135deg, #0ea371, #14b8a6);
      color: #f8fafc;
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.35);
    }
    .secondary {
      background: #0f172a;
      color: #f8fafc;
    }
    .ghost {
      background: #e5e7eb;
      color: #0f172a;
    }
    button:active { transform: translateY(1px) scale(0.995); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(16, 185, 129, 0.12);
      color: #047857;
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 600;
      font-size: 13px;
    }
    .status {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #f1f5f9;
      border: 1px solid rgba(15, 23, 42, 0.06);
      min-height: 76px;
    }
    .winner {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .tiny { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="controls">
      <div>
        <h1>ひらがなバイアス・ルーレット</h1>
        <p>名前は改行区切りで編集できます。スピンで当選者を決めましょう。</p>
      </div>

      <label class="badge" id="eligibleLabel">eligible: 0 / 0</label>
      <textarea id="namesInput" aria-label="参加者の名前を入力">
あいこ
さとう
うえの
かとう
えんどう
おおた
きむら
いのうえ
やまだ
たなか
      </textarea>

      <div class="actions">
        <button class="primary" id="spinBtn">スピンする</button>
        <button class="secondary" id="shuffleBtn">ランダム順にする</button>
        <button class="ghost" id="copyBtn">コピー</button>
        <button class="ghost" id="pasteBtn">貼り付け</button>
      </div>

      <div class="status">
        <div class="winner" id="winnerName">まだスピンしていません</div>
        <div class="tiny" id="statusDetail">「スピンする」を押すと動きます。</div>
      </div>
    </div>

    <div class="wheel-shell">
      <canvas id="wheel" width="800" height="800"></canvas>
      <div class="pointer"></div>
    </div>
  </div>

  <script>
    const wheel = document.getElementById('wheel');
    const ctx = wheel.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const namesInput = document.getElementById('namesInput');
    const winnerName = document.getElementById('winnerName');
    const statusDetail = document.getElementById('statusDetail');
    const eligibleLabel = document.getElementById('eligibleLabel');

    let names = [];
    let rotation = 0;
    let isSpinning = false;
    const vowelRegex = /[あいうえお]/;
    const palette = ['#10b981', '#0ea5e9', '#f97316', '#a855f7', '#f43f5e', '#22c55e', '#14b8a6', '#eab308'];

    const parseNames = () => namesInput.value
      .split('\n')
      .map(n => n.trim())
      .filter(Boolean);

    const shuffle = arr => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    const updateEligibleBadge = () => {
      const eligibleCount = names.filter(n => vowelRegex.test(n)).length;
      eligibleLabel.textContent = `eligible: ${eligibleCount} / ${names.length}`;
    };

    const drawWheel = () => {
      const size = wheel.width;
      const radius = size / 2;
      ctx.clearRect(0, 0, size, size);
      if (!names.length) return;

      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(rotation);

      const arc = (Math.PI * 2) / names.length;

      names.forEach((name, i) => {
        const start = i * arc;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, radius - 14, start, start + arc);
        ctx.closePath();
        ctx.fillStyle = palette[i % palette.length];
        ctx.globalAlpha = vowelRegex.test(name) ? 0.95 : 0.65;
        ctx.fill();

        ctx.save();
        ctx.rotate(start + arc / 2);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#0b1021';
        ctx.font = 'bold 22px "Space Grotesk", "Avenir Next", "Futura", sans-serif';
        ctx.shadowColor = 'rgba(0,0,0,0.25)';
        ctx.shadowBlur = 12;
        ctx.fillText(name, radius - 32, 8);
        ctx.restore();
      });

      ctx.restore();
      ctx.beginPath();
      ctx.arc(radius, radius, 26, 0, Math.PI * 2);
      ctx.fillStyle = '#111827';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(radius, radius, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#10b981';
      ctx.fill();
    };

    const pickWinner = () => {
      const eligible = names.filter(n => vowelRegex.test(n));
      if (eligible.length === 0) return null;
      const target = eligible[Math.floor(Math.random() * eligible.length)];
      return target;
    };

    const animateSpin = (winningIndex) => {
      const arc = (Math.PI * 2) / names.length;
      const targetAngle = (Math.PI * 1.5) - (winningIndex + 0.5) * arc;
      const extraSpins = 6 + Math.floor(Math.random() * 3);
      const finalRotation = (Math.PI * 2 * extraSpins) + targetAngle;
      const startRotation = rotation % (Math.PI * 2);
      const totalChange = finalRotation - startRotation;
      const duration = 3800;
      const start = performance.now();

      const easeOut = t => 1 - Math.pow(1 - t, 3);

      const frame = (now) => {
        const elapsed = now - start;
        const t = Math.min(elapsed / duration, 1);
        const wobble = Math.sin(t * Math.PI * 6) * (1 - t) * 0.08;
        const eased = easeOut(t);
        const progress = Math.max(0, eased + wobble);
        rotation = startRotation + totalChange * progress;
        drawWheel();

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          rotation = startRotation + totalChange;
          drawWheel();
          isSpinning = false;
        }
      };

      requestAnimationFrame(frame);
    };

    const spin = () => {
      if (isSpinning) return;
      names = parseNames();
      updateEligibleBadge();

      if (!names.length) {
        winnerName.textContent = '名前を入力してください。';
        statusDetail.textContent = '';
        drawWheel();
        return;
      }

      const winner = pickWinner();
      if (!winner) {
        winnerName.textContent = '対象の文字を含む名前がありません。';
        statusDetail.textContent = '「あ・い・う・え・お」を含む参加者を追加してください。';
        drawWheel();
        return;
      }

      const winningIndex = names.indexOf(winner);
      isSpinning = true;
      winnerName.textContent = 'スピン中...';
      statusDetail.textContent = 'ホイールがスピンしています。';
      animateSpin(winningIndex);

      setTimeout(() => {
        winnerName.textContent = `当選: ${winner}`;
        statusDetail.textContent = 'おめでとうございます。';
      }, 2300);
    };

    const syncInputAndDraw = () => {
      names = parseNames();
      updateEligibleBadge();
      drawWheel();
    };

    namesInput.addEventListener('input', syncInputAndDraw);
    spinBtn.addEventListener('click', spin);
    shuffleBtn.addEventListener('click', () => {
      names = shuffle(parseNames());
      namesInput.value = names.join('\n');
      syncInputAndDraw();
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(namesInput.value);
        statusDetail.textContent = 'コピーしました。';
      } catch (e) {
        statusDetail.textContent = 'コピーに失敗しました。';
      }
    });

    pasteBtn.addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        namesInput.value = text;
        syncInputAndDraw();
        statusDetail.textContent = '貼り付けました。';
      } catch (e) {
        statusDetail.textContent = '貼り付けに失敗しました。ブラウザの許可を確認してください。';
      }
    });

    // 初期描画
    syncInputAndDraw();
  </script>
</body>
</html>
